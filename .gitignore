# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (—Ç–∏—Ö–∏–π —Ä–µ–∂–∏–º)
!pip install biopython -q
!apt-get install -y muscle -qq

import os
from Bio import AlignIO, Phylo
from Bio.Phylo.TreeConstruction import DistanceCalculator, DistanceTreeConstructor
import matplotlib.pyplot as plt

# --- –ë–õ–û–ö –ü–†–û–í–ï–†–ö–ò –§–ê–ô–õ–ê ---
print("üìÇ –ü—Ä–æ–≤–µ—Ä—è—é —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ...")
files = os.listdir('.') # –°–º–æ—Ç—Ä–∏–º, —á—Ç–æ –ª–µ–∂–∏—Ç –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ
fasta_files = [f for f in files if f.endswith('.fasta') or f.endswith('.txt')]

if not fasta_files:
    print("‚ùå –û–®–ò–ë–ö–ê: Python –Ω–µ –≤–∏–¥–∏—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ .fasta!")
    print("–ß—Ç–æ –¥–µ–ª–∞—Ç—å: –Ω–∞–∂–º–∏—Ç–µ –∑–Ω–∞—á–æ–∫ –ü–∞–ø–∫–∏ —Å–ª–µ–≤–∞ –∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç—É–¥–∞ –≤–∞—à —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª.")
    print("–¢–µ–∫—É—â–∏–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ:", files)
    # –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
    raise FileNotFoundError("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏!")
else:
    print(f"‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã: {fasta_files}")
    # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ø–æ–ø–∞–≤—à–∏–π—Å—è fasta —Ñ–∞–π–ª (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Ç–≤–æ–π)
    target_file = "sequences.fasta"
    print(f"üëâ –ë—É–¥—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª: {target_file}")

# --- –ê–ù–ê–õ–ò–ó ---

# 2. –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ (Muscle)
output_aligned = "aligned_data.fasta"
print(f"‚è≥ –í—ã—Ä–∞–≤–Ω–∏–≤–∞—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–∑ {target_file}...")
# –ó–∞–ø—É—Å–∫–∞–µ–º muscle —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±)
os.system(f"muscle -in {target_file} -out {output_aligned}")
print("‚úÖ –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–æ.")

# 3. –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ
print("üå≥ –°—Ç—Ä–æ—é –¥–µ—Ä–µ–≤–æ...")
try:
    alignment = AlignIO.read(output_aligned, "fasta")
except ValueError:
    print("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è! –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –≤ —Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.")
    raise

calculator = DistanceCalculator('identity')
dm = calculator.get_distance(alignment)
constructor = DistanceTreeConstructor()
tree = constructor.nj(dm)

# 4. –†–∏—Å—É–µ–º –≥—Ä–∞—Ñ–∏–∫
plt.figure(figsize=(15, 10)) # –†–∞–∑–º–µ—Ä –ø–æ–±–æ–ª—å—à–µ
plt.title(f"–§–∏–ª–æ–≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–æ–µ –¥–µ—Ä–µ–≤–æ (–ø–æ —Ñ–∞–π–ª—É {target_file})")
Phylo.draw(tree, do_show=False)
plt.savefig("my_tree.png")
plt.show()

# 5. –¢–∞–±–ª–∏—Ü–∞ –º—É—Ç–∞—Ü–∏–π (–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —à—Ç–∞–º–º –∏–∑ –¢–í–û–ï–ì–û —Ñ–∞–π–ª–∞)
seq_old = alignment[0]
seq_new = alignment[-1]

print("\n" + "="*50)
print(f"üß¨ –ê–ù–ê–õ–ò–ó –ú–£–¢–ê–¶–ò–ô (–ø–æ —Ç–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º)")
print(f"–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º: {seq_old.id} (–ü–µ—Ä–≤—ã–π –≤ —Å–ø–∏—Å–∫–µ)")
print(f"–° —à—Ç–∞–º–º–æ–º:  {seq_new.id} (–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤ —Å–ø–∏—Å–∫–µ)")
print("="*50)

count = 0
print(f"{'–ü–æ–∑–∏—Ü–∏—è':<10} | {'–ë—ã–ª–æ':<5} -> {'–°—Ç–∞–ª–æ':<5}")
print("-" * 30)

for i in range(len(seq_old)):
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
    if seq_old[i] == "-" or seq_new[i] == "-":
        continue
    if seq_old[i] != seq_new[i]:
        count += 1
        # –í—ã–≤–æ–¥–∏–º –ø–µ—Ä–≤—ã–µ 15 –º—É—Ç–∞—Ü–∏–π
        if count <= 15:
            print(f"{i+1:<10} | {seq_old[i]:<5} -> {seq_new[i]:<5}")

print("-" * 30)
print(f"–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ –æ—Ç–ª–∏—á–∏–π: {count}")